<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Freduk CheckApp ‚Äî Lote + Braintree Sandbox (Real)</title>
  <style>
    :root{
      --bg:#000;
      --neon:#39ff14;
      --muted:#9fffcf;
      --panel:#081008;
    }
    body{ margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:var(--bg); color:var(--neon); padding:20px; }
    .container{ max-width:1100px; margin:0 auto; }
    h1{ text-align:center; color:var(--neon); margin:2px 0 14px; text-shadow:0 0 8px rgba(57,255,20,0.12); }
    .tabs{ display:flex; gap:8px; margin-bottom:14px; }
    .tab{ padding:8px 12px; border-radius:8px; cursor:pointer; background:#070707; border:1px solid rgba(57,255,20,0.04); color:var(--neon); font-weight:700; }
    .tab.active{ background:var(--neon); color:#000; box-shadow:0 6px 20px rgba(57,255,20,0.06); }
    .panel { background:var(--panel); border-radius:10px; padding:12px; border:1px solid rgba(57,255,20,0.04); margin-bottom:12px; }
    textarea, input[type="text"], select { width:100%; background:#050805; border:1px solid rgba(57,255,20,0.06); color:var(--neon); padding:10px 12px; border-radius:8px; font-family:monospace; }
    textarea{ height:140px; resize:vertical; }
    .row{ display:flex; gap:12px; margin-top:10px; flex-wrap:wrap; }
    .col{ flex:1; min-width:0; }
    button { background:var(--neon); color:#000; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:800; }
    button.ghost { background:transparent; border:1px solid rgba(57,255,20,0.08); color:var(--neon); }
    .panels{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:14px; }
    .panel-title{ display:flex; justify-content:space-between; align-items:center; font-weight:800; color:var(--neon); margin-bottom:8px; }
    .list{ max-height:420px; overflow:auto; display:flex; flex-direction:column; gap:8px; padding-right:6px; }
    .item{ display:flex; justify-content:space-between; align-items:center; padding:8px; border-radius:8px; color:#000; font-weight:700; }
    .item .left{ display:flex; gap:10px; align-items:center; }
    .item .card{ font-family:monospace; letter-spacing:1px; }
    .live{ background:#00c853; }    /* verde */
    .dead{ background:#e53935; }    /* rojo */
    .unknown{ background:#ffb703; color:#2a2000; } /* amarillo */
    .log-item{ background:#111; color:var(--neon); padding:8px; border-radius:8px; }
    .small{ font-size:13px; color:var(--muted); }
    .controls{ display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .counter-badges{ display:flex; gap:8px; margin-top:8px; font-weight:800; }
    .badge{ padding:6px 8px; border-radius:8px; }
    .badge.live{ color:#002b00; background:#00ff66; }
    .badge.dead{ color:#2a0000; background:#ff6464; }
    .badge.unknown{ color:#332100; background:#ffd86b; }

    /* responsive */
    @media (max-width:900px){
      .panels{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üêæ Freduk CheckApp üêæ </h1>

    <div class="tabs">
      <div id="tabLote" class="tab active">üî¢ Lote (Real)</div>
      <div id="tabSandbox" class="tab">üß† Sandbox Drop-in</div>
    </div>

    <!-- LOTE PANEL -->
    <div id="lotePanel" class="panel">
      <div class="small">Pega hasta 100 tarjetas (una por l√≠nea). Formato recomendado: <code>PAN|MM|YYYY|CVV</code>. Ej: <code>4111111111111111|04|2027|123</code></div>
      <textarea id="cardsArea" placeholder="4111111111111111|04|2027|123
4000111111111115|04|2027|123"></textarea>

      <div class="row">
        <div style="width:160px;">
          <label class="small">Delay (ms) entre tarjetas</label>
          <input id="delayInput" type="text" value="600" />
        </div>
        <div style="width:120px;">
          <label class="small">M√°x</label>
          <input id="maxInput" type="text" value="20" />
        </div>
        <div style="flex:1;">
          <label class="small">BINs aceptados (opcional, coma-separated)</label>
          <input id="binsInput" type="text" placeholder="453951,424242 (vac√≠o = todos)" />
        </div>
      </div>

      <div class="controls">
        <button id="startBatchBtn">Verificar Lote (Real)</button>
        <button id="stopBatchBtn" class="ghost" disabled>Detener</button>
        <button id="clearBatchBtn" class="ghost">Limpiar</button>
      </div>

      <div class="counter-badges">
        <div class="badge live">Live: <span id="cntLive">0</span></div>
        <div class="badge dead">Dead: <span id="cntDead">0</span></div>
        <div class="badge unknown">Unknown: <span id="cntUnknown">0</span></div>
        <div class="small" style="margin-left:auto">Procesadas: <span id="cntTotal">0</span></div>
      </div>

      <div class="panels">
        <div class="panel">
          <div class="panel-title"><span>üü© Live</span><span id="liveCount">0</span></div>
          <div id="liveList" class="list"></div>
        </div>

        <div class="panel">
          <div class="panel-title"><span>üü• Dead</span><span id="deadCount">0</span></div>
          <div id="deadList" class="list"></div>
        </div>

        <div style="grid-column: 1 / span 2; display:flex; gap:12px;">
          <div class="panel" style="flex:1">
            <div class="panel-title"><span>üü® Unknown</span><span id="unknownCount">0</span></div>
            <div id="unknownList" class="list"></div>
          </div>

          <div class="panel" style="flex:1">
            <div class="panel-title"><span>üìã Log</span><span id="logCount">0</span></div>
            <div id="logList" class="list"></div>
          </div>
        </div>
      </div>

      <div style="margin-top:10px; display:flex; gap:8px;">
        <button id="downloadAll">Descargar todo (.txt)</button>
        <button id="downloadLive" class="ghost">Descargar Live</button>
        <button id="downloadDead" class="ghost">Descargar Dead</button>
        <button id="downloadUnknown" class="ghost">Descargar Unknown</button>
      </div>

      <div class="small" style="margin-top:8px; color:#ffcc66">
        ‚ö†Ô∏è Atenci√≥n: en modo **Real (lote)** este formulario enviar√° los n√∫meros PIN/CVV al servidor (solo usar en SANDBOX para pruebas). No usar datos reales en entornos p√∫blicos.
      </div>
    </div>

    <!-- SANDBOX DROP-IN -->
    <div id="sandboxPanel" class="panel" style="display:none;">
      <div class="small">Modo Sandbox con Braintree Drop-in (tokenizaci√≥n segura). No se env√≠a PAN al servidor directamente: el cliente obtiene un nonce y el servidor lo verifica.</div>

      <div style="margin-top:10px;">
        <div id="dropin-container"></div>
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button id="verifyDropinBtn">Verificar (Drop-in)</button>
          <button id="destroyDropinBtn" class="ghost">Reiniciar Drop-in</button>
        </div>
        <div id="dropinResult" style="margin-top:8px;"></div>
      </div>

      <div style="margin-top:12px;">
        <div class="small">Resultados r√°pidos (Drop-in se agregan a paneles):</div>
      </div>
    </div>

  </div>

  <!-- Braintree Drop-in -->
  <script src="https://js.braintreegateway.com/web/dropin/1.33.7/js/dropin.min.js"></script>

  <script>
    // --------------------------
    // Variables / estado global
    // --------------------------
    let running = false;
    let rawCards = [];           // guardamos localmente lo pegado
    let indexToOriginal = {};    // √≠ndice -> original completo
    let resultsStore = { live:[], dead:[], unknown:[], log:[] };

    // DOM
    const tabLote = document.getElementById('tabLote');
    const tabSandbox = document.getElementById('tabSandbox');
    const lotePanel = document.getElementById('lotePanel');
    const sandboxPanel = document.getElementById('sandboxPanel');

    // Lote DOM
    const cardsArea = document.getElementById('cardsArea');
    const delayInput = document.getElementById('delayInput');
    const maxInput = document.getElementById('maxInput');
    const binsInput = document.getElementById('binsInput');
    const startBatchBtn = document.getElementById('startBatchBtn');
    const stopBatchBtn = document.getElementById('stopBatchBtn');
    const clearBatchBtn = document.getElementById('clearBatchBtn');

    const cntLive = document.getElementById('cntLive');
    const cntDead = document.getElementById('cntDead');
    const cntUnknown = document.getElementById('cntUnknown');
    const cntTotal = document.getElementById('cntTotal');

    const liveList = document.getElementById('liveList');
    const deadList = document.getElementById('deadList');
    const unknownList = document.getElementById('unknownList');
    const logList = document.getElementById('logList');

    const downloadAll = document.getElementById('downloadAll');
    const downloadLive = document.getElementById('downloadLive');
    const downloadDead = document.getElementById('downloadDead');
    const downloadUnknown = document.getElementById('downloadUnknown');

    // Sandbox DOM
    const dropinContainer = document.getElementById('dropin-container');
    const verifyDropinBtn = document.getElementById('verifyDropinBtn');
    const destroyDropinBtn = document.getElementById('destroyDropinBtn');
    const dropinResult = document.getElementById('dropinResult');

    // Braintree
    let dropinInstance = null;

    // --------------------------
    // UI: tabs
    // --------------------------
    tabLote.addEventListener('click', ()=> { tabLote.classList.add('active'); tabSandbox.classList.remove('active'); lotePanel.style.display='block'; sandboxPanel.style.display='none'; });
    tabSandbox.addEventListener('click', ()=> { tabSandbox.classList.add('active'); tabLote.classList.remove('active'); lotePanel.style.display='none'; sandboxPanel.style.display='block'; });

    // --------------------------
    // Helpers: UI + data
    // --------------------------
    function resetResults() {
      resultsStore = { live:[], dead:[], unknown:[], log:[] };
      liveList.innerHTML = ''; deadList.innerHTML = ''; unknownList.innerHTML = ''; logList.innerHTML = '';
      cntLive.textContent = '0'; cntDead.textContent = '0'; cntUnknown.textContent = '0'; cntTotal.textContent = '0';
    }

    function downloadText(filename, content) {
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      setTimeout(()=> { URL.revokeObjectURL(url); a.remove(); }, 600);
    }

    function maskNumberFull(num) {
      const s = String(num).replace(/\D/g,'');
      if (s.length <= 10) return s.replace(/\d/g,'*');
      const first6 = s.slice(0,6);
      const last4 = s.slice(-4);
      const mid = '*'.repeat(Math.max(0, s.length - 10));
      return `${first6}${mid}${last4}`;
    }

    function appendToPanel(panelEl, maskedText, estadoText, kind, originalCard = null) {
      const div = document.createElement('div');
      div.className = 'item ' + (kind === 'live' ? 'live' : kind === 'dead' ? 'dead' : 'unknown');

      const left = document.createElement('div'); left.className = 'left';
      const cardSpan = document.createElement('div'); cardSpan.className = 'card'; cardSpan.textContent = maskedText;
      const estadoSpan = document.createElement('div'); estadoSpan.className = 'small'; estadoSpan.textContent = estadoText;

      left.appendChild(cardSpan);
      left.appendChild(estadoSpan);

      const right = document.createElement('div');
      right.style.display='flex'; right.style.gap='8px';

      // Mostrar / Ocultar
      const showBtn = document.createElement('button'); showBtn.textContent='Mostrar'; showBtn.style.padding='6px'; showBtn.style.borderRadius='6px';
      // Copiar
      const copyBtn = document.createElement('button'); copyBtn.textContent='Copiar'; copyBtn.style.padding='6px'; copyBtn.style.borderRadius='6px';

      let revealed = false;
      showBtn.addEventListener('click', () => {
        if (!originalCard) return alert('N√∫mero completo no disponible localmente.');
        revealed = !revealed;
        cardSpan.textContent = revealed ? originalCard : maskedText;
        showBtn.textContent = revealed ? 'Ocultar' : 'Mostrar';
      });

      copyBtn.addEventListener('click', async () => {
        const toCopy = originalCard || maskedText;
        try {
          await navigator.clipboard.writeText(toCopy);
          copyBtn.textContent = 'Copiado';
          setTimeout(()=> copyBtn.textContent='Copiar', 1000);
        } catch (e) {
          const ta = document.createElement('textarea'); ta.value = toCopy; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
          copyBtn.textContent = 'Copiado'; setTimeout(()=> copyBtn.textContent='Copiar', 1000);
        }
      });

      right.appendChild(showBtn);
      right.appendChild(copyBtn);

      div.appendChild(left);
      div.appendChild(right);
      // prepend to show newest first
      panelEl.prepend(div);
    }

    function updateCounters() {
      cntLive.textContent = String(resultsStore.live.length);
      cntDead.textContent = String(resultsStore.dead.length);
      cntUnknown.textContent = String(resultsStore.unknown.length);
      cntTotal.textContent = String(resultsStore.live.length + resultsStore.dead.length + resultsStore.unknown.length);
      document.getElementById('liveCount').textContent = String(resultsStore.live.length);
      document.getElementById('deadCount').textContent = String(resultsStore.dead.length);
      document.getElementById('unknownCount').textContent = String(resultsStore.unknown.length);
      document.getElementById('logCount').textContent = String(resultsStore.log.length);
    }

    function classifyAndShow(resultObj, originalFromInput = null) {
      // resultObj: { masked, estado, detalle, input }
      const masked = resultObj.masked || resultObj.tarjeta || resultObj.input_masked || resultObj.input || '';
      const estadoText = resultObj.estado || resultObj.resultado || resultObj.detalle || (resultObj.ok ? 'Live' : 'Dead');
      const lower = String(estadoText).toLowerCase();

      // determine kind
      let kind = 'unknown';
      if (lower.includes('live')) kind = 'live';
      else if (lower.includes('dead')) kind = 'dead';
      else kind = 'unknown';

      // find original: originalFromInput if provided, else use index matching heuristics (last4)
      let original = originalFromInput || null;
      if (!original) {
        const last4 = String(masked).slice(-4);
        for (const v of rawCards) {
          if (String(v).trim().endsWith(last4)) { original = v; break; }
        }
      }

      // store and render
      resultsStore[kind].unshift({ masked, estado: estadoText, original });
      resultsStore.log.unshift({ masked, estado: estadoText, original, time: new Date().toLocaleTimeString() });

      appendToPanel(kind === 'live' ? liveList : kind === 'dead' ? deadList : unknownList, masked, estadoText, kind, original);
      appendToPanel(logList, (new Date().toLocaleTimeString() + ' | ' + masked + ' | ' + estadoText), estadoText, 'log', original);

      updateCounters();
    }

    // --------------------------
    // Braintree Drop-in (Sandbox)
    // --------------------------
    async function initDropin() {
      try {
        const t = await fetch('/api/client-token');
        const tj = await t.json();
        if (!tj.ok) { dropinResult.innerText = 'No se pudo obtener client token'; return; }

        dropinInstance = await new Promise((resolve, reject) => {
          braintree.dropin.create({
            authorization: tj.clientToken,
            container: '#dropin-container'
          }, (err, instance) => {
            if (err) return reject(err);
            resolve(instance);
          });
        });
      } catch (e) {
        console.error('initDropin error', e);
        dropinResult.innerText = 'Error inicializando Drop-in';
      }
    }

    verifyDropinBtn.addEventListener('click', async () => {
      if (!dropinInstance) { dropinResult.innerText = 'Drop-in no inicializado'; return; }
      dropinResult.innerText = 'Procesando...';
      dropinInstance.requestPaymentMethod(async (err, payload) => {
        if (err) { dropinResult.innerText = 'Error al leer tarjeta: ' + (err.message || err); return; }
        try {
          const r = await fetch('/api/verify-braintree', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ paymentMethodNonce: payload.nonce })
          });
          const data = await r.json();
          if (data.ok && data.estado === 'Live') {
            dropinResult.innerHTML = '<div style="padding:8px;border-radius:8px;background:#00c853;color:#001">‚úÖ Live ‚Äî ' + (data.detalle || '') + '</div>';
            // add to LIVE panel (no original available)
            classifyAndShow({ masked: 'Tokenized card', estado: '‚úÖ Live | ' + (data.detalle || '') }, null);
          } else {
            dropinResult.innerHTML = '<div style="padding:8px;border-radius:8px;background:#e53935;color:#100">‚ùå Dead ‚Äî ' + (data.msg || data.detalle || 'Rejected') + '</div>';
            classifyAndShow({ masked: 'Tokenized card', estado: '‚ùå Dead | ' + (data.msg || data.detalle || '') }, null);
          }
        } catch (e) {
          console.error(e);
          dropinResult.innerText = 'Error en verificaci√≥n';
        }
      });
    });

    destroyDropinBtn.addEventListener('click', async () => {
      if (dropinInstance) {
        try { dropinInstance.teardown(() => { dropinInstance = null; dropinContainer.innerHTML = ''; initDropin(); }); }
        catch(e){ console.warn('teardown', e); dropinContainer.innerHTML = ''; dropinInstance = null; initDropin(); }
      } else { initDropin(); }
    });

    // init on load
    initDropin();

    // --------------------------
    // BATCH (Real per-card requests)
    // --------------------------
    async function callVerifyBatchSingle(cardString) {
      // cardString formato "PAN|MM|YYYY|CVV" o similar
      try {
        const r = await fetch('/api/verify-braintree-batch', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ cards: [cardString] })
        });
        return await r.json();
      } catch (e) {
        console.error('callVerifyBatchSingle error', e);
        return { ok:false, msg: 'Error de conexi√≥n' };
      }
    }

    startBatchBtn.addEventListener('click', async () => {
      if (running) return;
      resetResults();

      let delay = parseInt(delayInput.value || '400', 10);
      if (Number.isNaN(delay) || delay < 50) delay = 400;
      let max = parseInt(maxInput.value || '100', 300);
      if (Number.isNaN(max) || max < 1) max = 100;

      let raw = cardsArea.value.split('\n').map(s=>s.trim()).filter(Boolean);
      if (raw.length === 0) { alert('Pega al menos 1 tarjeta.'); return; }
      raw = raw.slice(0, max);

      // guardar copia y mapa √≠ndice->original
      rawCards = raw.slice();
      indexToOriginal = {};
      rawCards.forEach((r,i)=> indexToOriginal[i] = r);

      const binsRaw = binsInput.value.trim();
      const binsSet = binsRaw ? new Set(binsRaw.split(',').map(b=>b.trim())) : null;

      running = true;
      startBatchBtn.disabled = true;
      stopBatchBtn.disabled = false;

      for (let i = 0; i < raw.length; i++) {
        if (!running) break;
        const cardLine = raw[i];
        // si binsSet definido, quick-check bin
        const pan = String(cardLine).split('|')[0].replace(/\D/g,'');
        const bin = pan.slice(0,6);
        if (binsSet && !binsSet.has(bin)) {
          // marcar como unknown/BIN not allowed
          classifyAndShow({ masked: maskNumberFull(pan), estado: `‚ö†Ô∏è BIN no permitido (${bin})` }, cardLine);
          await new Promise(r=>setTimeout(r, delay));
          continue;
        }

        // llamar al endpoint (env√≠a 1 tarjeta en un array)
        const resp = await callVerifyBatchSingle(cardLine);
        if (!resp.ok && resp.resultados && Array.isArray(resp.resultados)) {
          // edge: sometimes ok true but resultados present
        }
        // resp may be { ok:true, total:1, resultados: [...] } or { ok:false, msg: ...}
        if (resp.ok && Array.isArray(resp.resultados)) {
          const item = resp.resultados[0];
          // item has { input, masked, estado, detalle, ok }
          const masked = item.masked || (item.input ? (item.input.slice(0,6) + '*'.repeat(Math.max(0, item.input.length-10)) + item.input.slice(-4)) : maskNumberFull(pan));
          const estado = item.estado || (item.ok ? 'Live' : 'Dead');
          classifyAndShow({ masked, estado: `${estado} | ${item.detalle || ''}`, input: item.input }, cardLine);
        } else if (resp.ok && resp.resultados === undefined && resp.resultado) {
          // fallback older formats
          classifyAndShow({ masked: maskNumberFull(pan), estado: String(resp.resultado) || 'Dead' }, cardLine);
        } else if (resp.ok === false && resp.msg) {
          classifyAndShow({ masked: maskNumberFull(pan), estado: '‚ùå Error: ' + resp.msg }, cardLine);
        } else {
          // unknown fallback
          classifyAndShow({ masked: maskNumberFull(pan), estado: '‚ö†Ô∏è Respuesta inv√°lida' }, cardLine);
        }

        await new Promise(r=>setTimeout(r, delay));
      }

      running = false;
      startBatchBtn.disabled = false;
      stopBatchBtn.disabled = true;
    });

    stopBatchBtn.addEventListener('click', ()=> {
      running = false;
      startBatchBtn.disabled = false;
      stopBatchBtn.disabled = true;
    });

    clearBatchBtn.addEventListener('click', ()=> {
      if (running) { alert('Det√©n el proceso antes de limpiar'); return; }
      cardsArea.value = ''; rawCards = []; indexToOriginal = {}; resetResults();
    });

    // --------------------------
    // DOWNLOADS
    // --------------------------
    downloadAll.addEventListener('click', ()=> {
      const all = [...resultsStore.live, ...resultsStore.dead, ...resultsStore.unknown];
      if (!all.length) { alert('No hay resultados'); return; }
      const txt = all.map(r => `${r.original || r.masked} | ${r.estado}`).join('\n');
      downloadText('resultados_all.txt', txt);
    });
    downloadLive.addEventListener('click', ()=> {
      if (!resultsStore.live.length) { alert('No hay Live'); return; }
      downloadText('live.txt', resultsStore.live.map(r=>`${r.original || r.masked} | ${r.estado}`).join('\n'));
    });
    downloadDead.addEventListener('click', ()=> {
      if (!resultsStore.dead.length) { alert('No hay Dead'); return; }
      downloadText('dead.txt', resultsStore.dead.map(r=>`${r.original || r.masked} | ${r.estado}`).join('\n'));
    });
    downloadUnknown.addEventListener('click', ()=> {
      if (!resultsStore.unknown.length) { alert('No hay Unknown'); return; }
      downloadText('unknown.txt', resultsStore.unknown.map(r=>`${r.original || r.masked} | ${r.estado}`).join('\n'));
    });

    // Inicializar contadores (vacia)
    resetResults();

    // Helper: maskNumberFull used above
    function maskNumberFull(num) {
      const s = String(num).replace(/\D/g,'');
      if (!s) return '';
      if (s.length <= 10) return s.replace(/\d/g,'*');
      const first6 = s.slice(0,6);
      const last4 = s.slice(-4);
      const middle = '*'.repeat(Math.max(0, s.length - 10));
      return `${first6}${middle}${last4}`;
    }
  </script>
</body>
</html>
